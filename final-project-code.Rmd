---
title: 'W241 Experiments and Causality Final Project'
author: 'Guatam Karnataki, Adara Liao, Yaran Zhang' 
output:
  rmarkdown::github_document
---

**Contents**
Part 1: Process and Generate Clean Survey Data 
Part 2: Generate Modeling Data: add Y and other Outcome Variable for modeling use
Part 3: EDA for Covarites
Part 4: EDA for Outcome Variables
Part 5: Model 1 xxxx
Part 6: Model 2 xxxx
Part 7: xxx

**DataFrame Introcuction**
**d.clean.survey**: clean data direclty from survey, with below fields
**d.clean.model**: clean data from Survey + Outcome Varaibles + Other variables ONLY for modeling purpose


```{r}
# load packages 
library(data.table)
library(foreign)
library(lmtest)
library(stargazer)
library(sandwich)
library(bit64)
library(ggplot2)
library(dplyr)
library(scales)
library(stringr)
library(reshape2)

```


```{r}
##################################### Part 1: Process and Generate Clean Survey Data 
#### result dataframe:  d.clean.survey

# Load survey result from CSV
dsm <- fread("./data/sm_results.csv")
dq <- fread("./data/qualtrics_results.csv")

# Convert column type for merge purpose
dsm <- transform(dsm, year_of_birth =  as.character(year_of_birth))
dsm <- transform(dsm, respondent_id =  as.character(respondent_id))

# Correct column name for SM file
colnames(dsm)[colnames(dsm)=="psyciatrist"] <- "psychiatrist"
colnames(dsm)[colnames(dsm)=="denstist"] <- "dentist"
colnames(dq)[colnames(dq)=="end_Date"] <- "end_date"

# UNION SM result and Q result except for gender-specific columns
d.clean.survey <- rbind(dsm[,c(1:10, 15:18)], dq[, 2:15], fill=TRUE)

# Append gender-specific columns from Q result
d.clean.survey$gender_specific_physician1[d.clean.survey$channel == "qualtrics"] <- "Female"
d.clean.survey$gender_specific_score1[d.clean.survey$channel == "qualtrics"]  <- coalesce(dq$urologist_score1, dq$obgyn_score1)
d.clean.survey$gender_specific_physician2[d.clean.survey$channel == "qualtrics"]  <- "Female"
d.clean.survey$gender_specific_score2[d.clean.survey$channel == "qualtrics"]  <- coalesce(dq$urologist_score2, dq$obgyn_score2)
d.clean.survey$gender_specific_physician3 [d.clean.survey$channel == "qualtrics"] <- "Male"
d.clean.survey$gender_specific_score3[d.clean.survey$channel == "qualtrics"]  <- coalesce(dq$urologist_score3, dq$obgyn_score3)
d.clean.survey$gender_specific_physician4[d.clean.survey$channel == "qualtrics"]  <- "Male"
d.clean.survey$gender_specific_score4[d.clean.survey$channel == "qualtrics"]  <- coalesce(dq$urologist_score4, dq$obgyn_score4)

# Remove irregular words
d.clean.survey$race <- gsub("\xeb_", " ", d.clean.survey$race)
d.clean.survey$income <- gsub("\xeb_", " ", d.clean.survey$income)
d.clean.survey$degree <- gsub("\xeb_", " ", d.clean.survey$degree)
d.clean.survey$income <- gsub("\xeb_", " ", d.clean.survey$income)
d.clean.survey$degree <- gsub("<eb>_", " ", d.clean.survey$degree)

# Set NA
d.clean.survey$pcp[d.clean.survey$pcp == "NULL"] <- NA
d.clean.survey$cardiologist[d.clean.survey$cardiologist == "NULL"] <- NA
d.clean.survey$psychiatrist[d.clean.survey$psychiatrist == "NULL"] <- NA
d.clean.survey$dentist[d.clean.survey$dentist == "NULL"] <- NA

# Make gender value consistent
d.clean.survey$gender[d.clean.survey$gender == "male"] <- "Male"
d.clean.survey$pcp[d.clean.survey$pcp == "male"] <- "Male"
d.clean.survey$cardiologist[d.clean.survey$cardiologist == "male"] <- "Male"
d.clean.survey$psychiatrist[d.clean.survey$psychiatrist == "male"] <- "Male"
d.clean.survey$dentist[d.clean.survey$dentist == "male"] <- "Male"

d.clean.survey$gender[d.clean.survey$gender == "female"] <- "Female"
d.clean.survey$pcp[d.clean.survey$pcp == "female"] <- "Female"
d.clean.survey$cardiologist[d.clean.survey$cardiologist == "female"] <- "Female"
d.clean.survey$psychiatrist[d.clean.survey$psychiatrist == "female"] <- "Female"
d.clean.survey$dentist[d.clean.survey$dentist == "female"] <- "Female"

# Make degree value consistent
d.clean.survey$degree <-  gsub("degree", "Degree", d.clean.survey$degree)
d.clean.survey$degree[d.clean.survey$degree == "High school graduate (high school diploma or equivalent including GED)"] <-  "High School Graduate"
d.clean.survey$degree[d.clean.survey$degree == "Professional Degree (JD, MD)"] <-  "Professional Degree (MD, JD etc.)"


# Make race value consistent
d.clean.survey$race <-  gsub("American Indian or Alaskan Native", "American Indian or Alaska Native", d.clean.survey$race)
d.clean.survey$race <-  gsub("Others not mentioned above", "Others not mentioned", d.clean.survey$race)
d.clean.survey$race <-  gsub("Prefer not to disclose", "Prefer NOT to disclose", d.clean.survey$race)

# Correct year_of_birth data and convert to int
d.clean.survey$year_of_birth <-  gsub("3/22/92", "1992", d.clean.survey$year_of_birth)
d.clean.survey$year_of_birth <-  gsub("5/21/84", "1984", d.clean.survey$year_of_birth)
d.clean.survey$year_of_birth <-  gsub("6/3/80", "1980", d.clean.survey$year_of_birth)
d.clean.survey$year_of_birth <-  gsub("5281993", "1993", d.clean.survey$year_of_birth)
d.clean.survey$year_of_birth <-  gsub("3/29/84", "1992", d.clean.survey$year_of_birth)


# Make income value consistent
d.clean.survey$income[d.clean.survey$income == "$50,000 and $99,999"] <- "$50,000 to $99,999"
d.clean.survey$income[d.clean.survey$income == "$150,000 or $199,999"] <- "$50,000 to $99,999"
d.clean.survey$income[d.clean.survey$income == "More than $199,999"] <- "$200,000 or more"


# Improve format
d.clean.survey$channel <-  gsub("surveymonkey", "SurveyMonkey", d.clean.survey$channel)
d.clean.survey$channel <-  gsub("qualtrics", "Qualtrics", d.clean.survey$channel)

# Make Survey Monkey timestamp length consistent Compliance Check
d.clean.survey[nchar(d.clean.survey$start_date) == 12,]$start_date <- gsub(" ", " 0", d.clean.survey[nchar(d.clean.survey$start_date) == 12,]$start_date)
d.clean.survey[nchar(d.clean.survey$end_date) == 12,]$end_date <- gsub(" ", " 0", d.clean.survey[nchar(d.clean.survey$end_date) == 12,]$end_date)

# Preview data
head(d.clean.survey)

# Save in CSV as backup
write.csv(d.clean.survey, file = "d_clean_survey.csv")

```

```{r}
##################################### Part 1.5: Compliance Check - add duration column and plot
#### result dataframe:  d.clean.survey

# Calculate durartion(in minutes) to complete survey 
d.clean.survey$duration_min[d.clean.survey$channel=="SurveyMonkey"] <-  ( as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="SurveyMonkey"], 3, 4)) - as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="SurveyMonkey"], 3, 4)) ) * 1440 + (as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="SurveyMonkey"], 9, 10)) - as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="SurveyMonkey"], 9, 10)) ) * 60  +  (  as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="SurveyMonkey"], 12, 13))  - as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="SurveyMonkey"], 12, 13)) )

d.clean.survey$duration_min[d.clean.survey$channel=="Qualtrics"] <-  ( as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="Qualtrics"], 9, 10)) - as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="Qualtrics"], 9, 10)) ) * 1440 + ( as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="Qualtrics"], 12, 13)) - as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="Qualtrics"], 12, 13)) ) * 60  +  (  as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="Qualtrics"], 15, 16))  -  as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="Qualtrics"], 15, 16))) + ( as.numeric(substr(d.clean.survey$end_date[d.clean.survey$channel=="Qualtrics"], 18, 19))  -  as.numeric(substr(d.clean.survey$start_date[d.clean.survey$channel=="Qualtrics"], 18, 19)))/60

# Preview data
head(d.clean.survey)

d.clean.survey$duration_min_category <- case_when(
  d.clean.survey$duration_min <=1 ~ "layer0: Less than 1 minute",
  d.clean.survey$duration_min <=2 & d.clean.survey$duration_min > 1  ~ "layer1:  1~2 minutes",
  d.clean.survey$duration_min <=3 & d.clean.survey$duration_min > 2  ~ "layer2:  2~3 minutes",
  d.clean.survey$duration_min <=4 & d.clean.survey$duration_min > 3  ~ "layer3:  3~4 minutes",
  d.clean.survey$duration_min <=5 & d.clean.survey$duration_min > 4  ~ "layer4:  4~5 minutes",
  d.clean.survey$duration_min <=10 & d.clean.survey$duration_min > 5  ~ "layer5:  5~10 minutes",
  d.clean.survey$duration_min <=20 & d.clean.survey$duration_min > 10  ~ "layer6: 10~20 minutes",
  d.clean.survey$duration_min <=100 & d.clean.survey$duration_min > 20  ~ "layer7: 20~100 minutes",
  d.clean.survey$duration_min <=1000 & d.clean.survey$duration_min > 100  ~ "layer8: 100~1000 minutes",
  d.clean.survey$duration_min > 1000  ~ "layer9: More than 1000 minutes")

ggplot(data=d.clean.survey, aes(x=duration_min_category, fill=duration_min_category)) +
  geom_bar() +
  geom_text( stat='count' , aes(label=..count..), vjust=-0.5) +
  scale_x_discrete(labels = wrap_format(10)) + 
  theme(legend.position = "none") +
  xlab("Time to Complete Survey (in minutes)")

# # Compliance Check: duration_min distribution from 0 to 5.9k
# ggplot(data.frame(d.clean.survey[d.clean.survey$duration_min<=20,]), aes(y=duration_min)) +
#   geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=4)
# 
# ggplot(data.frame(d.clean.survey[d.clean.survey$duration_min>20 & d.clean.survey$duration_min<1000,]), aes(x=duration_min)) +
#   geom_bar() + 
#     coord_cartesian(xlim = c(20, 1000))
# 
# ggplot(data.frame(d.clean.survey[d.clean.survey$duration_min>1000,]), aes(x=duration_min)) +
#   geom_bar() + 
#     coord_cartesian(xlim = c(1000, 6000))
# 
# # Compliance Check: duration_min < 2 minutes, considered as not a valid feedback
# nrow(d.clean.survey[d.clean.survey$duration_min<1,]) # 4 rows
# nrow(d.clean.survey[d.clean.survey$duration_min<2,]) # 56 rows


```

```{r}
##################################### Part 2: Generate Modeling Data: add Y and other Outcome Variable for modeling use
#### result dataframe:  d.clean.model
#### result dataframe:  d.clean.model.trans

# Genderate Y for 4 non-gender-specific specialty
d.clean.model <- d.clean.survey

d.clean.model[,Y_pcp := ifelse(gender==pcp, 1, -1)]
d.clean.model[,Y_cardio := ifelse(gender==cardiologist, 1, -1)]
d.clean.model[,Y_psy := ifelse(gender==psychiatrist, 1, -1)]
d.clean.model[,Y_den := ifelse(gender==dentist, 1, -1)]
d.clean.model[,Y_1 := Y_pcp + Y_cardio + Y_psy + Y_den]

# Generate #of Famele/Male within 3 specs
d.clean.model$Y_4spec_female <- str_count(paste(d.clean.model$pcp, d.clean.model$cardiologist, d.clean.model$psychiatrist, d.clean.model$dentist), "Female")
d.clean.model$Y_4spec_male <- str_count(paste(d.clean.model$pcp, d.clean.model$cardiologist, d.clean.model$psychiatrist, d.clean.model$dentist), "Male")
d.clean.model <- d.clean.model[(d.clean.model$Y_4spec_female + d.clean.model$Y_4spec_male) == 4,]


######## Create transpose dataframe
d.clean.model.trans  <- melt(d.clean.model[,c(2, 11:14)], id.vars="respondent_id",  
                             variable.name = "4spec_type", value.name="gender_selected", na.rm=TRUE)

d.clean.model.trans[, Y_if_female := ifelse(gender_selected=="Female", 1, 0)]


# Preview data
head(d.clean.model)
head(d.clean.model.trans)

```

```{r}

##################################### Part 3: EDA for Covarites 
library(scales)

d.cov.eda <- d.clean.survey

d.cov.eda$year_of_birth_range <- case_when(
  d.cov.eda$year_of_birth >= 1930 & d.cov.eda$year_of_birth < 1940 ~ "1930~1939",
  d.cov.eda$year_of_birth >= 1940 & d.cov.eda$year_of_birth < 1950 ~ "1940~1949",
  d.cov.eda$year_of_birth >= 1950 & d.cov.eda$year_of_birth < 1960 ~ "1950~1959",
  d.cov.eda$year_of_birth >= 1960 & d.cov.eda$year_of_birth < 1970 ~ "1960~1969",
  d.cov.eda$year_of_birth >= 1970 & d.cov.eda$year_of_birth < 1980 ~ "1970~1979",
  d.cov.eda$year_of_birth >= 1980 & d.cov.eda$year_of_birth < 1990 ~ "1980~1989",
  d.cov.eda$year_of_birth >= 1990 & d.cov.eda$year_of_birth < 2000 ~ "1990~1999",
  d.cov.eda$year_of_birth >= 2000 & d.cov.eda$year_of_birth < 2010 ~ "2000~2009",
  d.cov.eda$year_of_birth >= 2010 & d.cov.eda$year_of_birth < 2020 ~ "2010~2019",
  TRUE ~ "other"
)

d.cov.eda$age_range <- case_when(
  d.cov.eda$year_of_birth < 1960 ~ "60+",
  d.cov.eda$year_of_birth >= 1960 & d.cov.eda$year_of_birth < 1975 ~ "45~60",
  d.cov.eda$year_of_birth >= 1975 & d.cov.eda$year_of_birth < 1990 ~ "30~44",
  d.cov.eda$year_of_birth >= 1990 & d.cov.eda$year_of_birth < 2002 ~ "18~29",
  d.cov.eda$year_of_birth >= 2002 & d.cov.eda$year_of_birth < 2020 ~ "18-",
  TRUE ~ "other"
)

d.cov.eda %>% 
    count(age_range = factor(age_range), gender = factor(gender)) %>% 
    mutate(pct = prop.table(n)) %>% 
    ggplot(aes(x = age_range, y = pct, fill = gender, label = scales::percent(pct))) + 
    geom_col(position = 'stack') +     
    theme(legend.position = c(0.9, 0.85), axis.text.x = element_text(angle = 0, hjust = 1)) +
    geom_text(position = position_stack(vjust = 0.5),
              size = 3) + 
    scale_y_continuous(labels = scales::percent)   #  #labels=function(x) paste0(x,"%")


d.cov.eda %>% 
    count(race = factor(race), gender = factor(gender)) %>% 
    mutate(pct = prop.table(n)) %>% 
    ggplot(aes(x = race, y = pct, fill = gender, label = scales::percent(pct))) + 
    geom_col(position = 'stack') +     
    theme(legend.position = c(0.7, 0.85), axis.text.x = element_text(angle = 0, hjust = 1)) +
    scale_x_discrete(labels = wrap_format(10)) + 
    geom_text(position = position_stack(vjust = 0.5),
              size = 3) + 
    scale_y_continuous(labels = scales::percent)   #  #labels=function(x) paste0(x,"%")


# unique(d.cov.eda$degree)
d.cov.eda$degree_order <- case_when(
  d.cov.eda$degree == "Less than high school Degree" ~ "0-Less than high school Degreee",
  d.cov.eda$degree == "High School Graduate" ~ "1-High School Graduate",
  d.cov.eda$degree == "Associate Degree (2-year)" ~ "2-Associate Degree (2-year)",
  d.cov.eda$degree == "Bachelor's Degree (4-year)" ~ "3-Bachelor's Degree (4-year)",
  d.cov.eda$degree == "Master's Degree" ~ "4-Master's Degree",
  d.cov.eda$degree == "Doctoral Degree" ~ "5-Doctoral Degree",
  d.cov.eda$degree == "Professional Degree (MD, JD etc.)" ~ "6-Professional Degree (MD, JD etc.)")


d.cov.eda %>% 
    count(degree = factor(degree_order), gender = factor(gender)) %>% 
    mutate(pct = prop.table(n)) %>% 
    ggplot(aes(x = degree, y = pct, fill = gender, label = scales::percent(pct))) + 
    geom_col(position = 'stack') +     
    theme(legend.position = c(0.9, 0.85), axis.text.x = element_text(angle = 0, hjust = 1)) +
    scale_x_discrete(labels = wrap_format(10)) + 
    geom_text(position = position_stack(vjust = 0.5),
              size = 3) + 
    scale_y_continuous(labels = scales::percent)   #  #labels=function(x) paste0(x,"%")


# unique(d.cov.eda$income)
d.cov.eda$income_edge <- case_when(
  d.cov.eda$income == "$50,000 to $99,999" ~ 50000,
  d.cov.eda$income == "$200,000 or more" ~ 200000,
  d.cov.eda$income == "$10,000 to $49,999" ~ 10000,
  d.cov.eda$income == "$100,000 to $149,999" ~ 100000,
  d.cov.eda$income == "Less than $10,000" ~ 0,
  d.cov.eda$income == "$150,000 to $199,999" ~ 150000)

d.cov.eda %>% 
    count(income = factor(income_edge), gender = factor(gender)) %>% 
    mutate(pct = prop.table(n)) %>% 
    ggplot(aes(x = income, y = pct, fill = gender, label = scales::percent(pct))) + 
    geom_col(position = 'stack') +     
    theme(legend.position = c(0.9, 0.85), axis.text.x = element_text(angle = 0, hjust = 1)) +
    scale_x_discrete(labels = wrap_format(10)) + 
    geom_text(position = position_stack(vjust = 0.5),
              size = 3) + 
    scale_y_continuous(labels = scales::percent)   #  #labels=function(x) paste0(x,"%")




```

```{r}
##################################### Part 4: EDA for Outcome Variables 
ggplot(data.frame(d.clean.model), aes(x=Y_1, fill=gender)) +
  geom_bar() 

```


```{r}
##################################### Part 5: Model 1 xxxx
# Overall averages
d <- d.clean.survey[,c("gender","Y_1")]
d <- na.omit(d)

total <- d[,.N]
all <- d[, .(pct_all = (.N/total*100)), keyby=(Y_1)]
ggplot(data=all, aes(x=factor(Y_1), y=pct_all)) + geom_bar(stat="identity")

# Gender specific averages
d[gender=="Male", .N]/d[,.N]
d[gender=="Female", .N]/d[,.N]

d <- na.omit(d.clean.survey[,c("gender", "Y_1")])
all<-d[, .N, keyby=.(gender, Y_1)]
ggplot(data=all, aes(x=factor(Y_1), y=N, fill=gender)) + geom_bar(stat="identity", 
                                                                  position=position_dodge())
```
```{r}
# Effects by gender and speciality

d <- na.omit(d.clean.survey[,c("gender","Y_pcp")])
all<-d[, .N, keyby=.(gender, Y_pcp)]
ggplot(data=all, aes(x=factor(Y_pcp), y=N, fill=gender)) + geom_bar(stat="identity",
                                                                    position=position_dodge())

d <- na.omit(d.clean.survey[,c("gender", "Y_den")])
all<-d[, .N, keyby=.(gender, Y_den)]
ggplot(data=all, aes(x=factor(Y_den), y=N, fill=gender)) + geom_bar(stat="identity",
                                                                    position=position_dodge())

d <- na.omit(d.clean.survey[,c("gender", "Y_psy")])
all<-d[, .N, keyby=.(gender, Y_psy)]
ggplot(data=all, aes(x=factor(Y_psy), y=N, fill=gender)) + geom_bar(stat="identity",
                                                                    position=position_dodge())

d <- na.omit(d.clean.survey[,c("gender", "Y_cardio")])
all<-d[, .N, keyby=.(gender, Y_cardio)]
ggplot(data=all, aes(x=factor(Y_cardio), y=N, fill=gender)) + geom_bar(stat="identity",
                                                                    position=position_dodge())


```
```{r}
# Income effects
d <- na.omit(d.clean.survey[,c("income","Y_1")])
total <- d[,.N]
all<-d[, .(pct = (.N/total)), keyby=.(income, Y_1)]
ggplot(data=all, aes(x=factor(Y_1), y=pct, fill=income)) + geom_bar(stat="identity",
                                                                    position=position_dodge())

```
```{r}
# Race effects
d <- na.omit(d.clean.survey[,c("race","Y_1")])
total <- d[,.N]
all<-d[, .(pct = (.N/total)), keyby=.(race, Y_1)]
ggplot(data=all, aes(x=factor(Y_1), y=pct, fill=race)) + geom_bar(stat="identity",
                                                                    position=position_dodge())
```

```{r}
d <- d.clean.survey[,c("channel", "gender","race","income","degree","Y_1")]
d <- na.omit(d)
```

```{r}
# Model 1 - Effect of participant gender on outcome
m_gender <- d[, lm(Y_1 ~ gender)]
summary(m_gender)
```

```{r}
# Model 2 - Effet of participant race on outcome
m_race <- d[, lm(Y_1 ~ race)]
summary(m_race)
```

```{r}
# Model 3 - Effect of participant degree on outcome
m_degree <- d[, lm(Y_1 ~ degree)]
summary(m_degree)
```

```{r}
# Model 4 - Effect of participant income on outcome
m_income <- d[, lm(Y_1 ~ income)]
summary(m_income)
```

```{r}
# Model 5 - Interaction effect of gender and race
m_gender_race <- d[, lm(Y_1 ~ gender + race + gender * race)]
summary(m_gender_race)
```
```{r}
# Model 6 - Interaction effect of gender and race
m_gender_income <- d[, lm(Y_1 ~ gender + income + gender * income)]
summary(m_gender_income)
```
```{r}
# Model 7 - Interaction effect of gender and degree
m_gender_degree <- d[, lm(Y_1 ~ gender + degree + gender * degree)]
summary(m_gender_degree)
```

```{r}
# Use stargazer to consolidate all the models
stargazer(m_gender, 
          m_degree, 
          m_race,
          m_gender_race,
          m_gender_income,
          m_gender_degree,
          type="text")


```